## Overview

The Trade Processing APIs are used to provide the account owner with information on their trade instructions within their accounts for a given date range or specific time during the day.

This document provides the guidelines required to enable organisations to implement the Settlement and Safekeeping API responses into their systems and processes. 

Trade Status API – allows clients to access trade related information and the latest status for all settled and pending trade instructions
This documentation is available for download using the following link: Custody Technical Specification -Trade Status V2.5 April 2021 API Portal


## Getting Started

### Terms and Condiditions

### Contact Detail


## Authentication
### API gateway

Clients should authenticate their API access by including their secret token in the API request. All API requests to the Securities Services API Gateway must be made over HTTPS.

The Securities Services API Gateway manages our client authentication and redirects the API request to the relevant domain platform. As all transmission will be over HTTPS (TLS 1.2 or above), and the web traffic will be encrypted from eavesdropping during transmission.

### Security token

Securities Services APIs uses security token for authentication and authorisation.

During the API Onboarding, we require the client to complete an API Profile Application Form. For each API Profile Application Form, we will generate one security token, i.e. one security token per API Profile Account. These security tokens are generated by the Securities Services Internal API Administrative Console, which is not accessible through the Internet.

Upon completion of the End to End API Testing and the terms and conditions being signed, the Securities Services API Onboarding team will send the token through secure email to client’s Token Delivery email address.


This security token is the Bearer token under the OAuth2.0 Authorisation Framework. It should be added to the client’s HTTP authorisation header in the request. This initial security token default expiry period is for one year. Close to the token expiry, subject to a token overlap period (default is 30 days and can be customised according to our client’s requirements), a secure email containing the new token will be sent to the Token Delivery Email address and specify the new token effective date and expiry date.

Securities Services will manage the security token (revoke/re-generate) on request.

### Additional security features

Securities Services API provides IP white-listing as an additional security measure. Client can specify the IP addresses they would like to access the Securities Services API with. IP addresses outside of the whitelist will not be able to access the API service.

Securities Services API also supports connection using leased line which provide a secured channel between the client network and HSBC network.

## Requests and Response

<h3 id="account-and-transaction-api-specification-account-access">Account Access</h3>
 <a id="opIdCreateAccountAccessConsents"></a>
`POST /account-access-consents`

Create Account Access Consents

> Body parameter

```json
{
  "Data": {
    "Permissions": [
      "ReadAccountsBasic"
    ],
    "ExpirationDateTime": "2019-08-24T14:15:22Z",
    "TransactionFromDateTime": "2019-08-24T14:15:22Z",
    "TransactionToDateTime": "2019-08-24T14:15:22Z"
  },
  "Risk": {}
}
```

<h3 id="createaccountaccessconsents-parameters">Parameters</h3>

|Name|In|Type|Required|Description|
|---|---|---|---|---|
|x-fapi-auth-date|header|string|false|The time when the PSU last logged in with the TPP. |
|x-fapi-customer-ip-address|header|string|false|The PSU's IP address if the PSU is currently logged in with the TPP.|
|x-fapi-interaction-id|header|string|false|An RFC4122 UID used as a correlation id.|
|Authorization|header|string|true|An Authorisation Token as per https://tools.ietf.org/html/rfc6750|
|x-customer-user-agent|header|string|false|Indicates the user-agent that the PSU is using.|
|body|body|[OBReadConsent1](#schemaobreadconsent1)|true|Default|

#### Detailed descriptions

**x-fapi-auth-date**: The time when the PSU last logged in with the TPP. 
All dates in the HTTP headers are represented as RFC 7231 Full Dates. An example is below: 
Sun, 10 Sep 2017 19:43:31 UTC

> Example responses

> 201 Response

```json
{
  "Data": {
    "ConsentId": "string",
    "CreationDateTime": "2019-08-24T14:15:22Z",
    "Status": "Authorised",
    "StatusUpdateDateTime": "2019-08-24T14:15:22Z",
    "Permissions": [
      "ReadAccountsBasic"
    ],
    "ExpirationDateTime": "2019-08-24T14:15:22Z",
    "TransactionFromDateTime": "2019-08-24T14:15:22Z",
    "TransactionToDateTime": "2019-08-24T14:15:22Z"
  },
  "Risk": {},
  "Links": {
    "Self": "http://example.com",
    "First": "http://example.com",
    "Prev": "http://example.com",
    "Next": "http://example.com",
    "Last": "http://example.com"
  },
  "Meta": {
    "TotalPages": 0,
    "FirstAvailableDateTime": "2019-08-24T14:15:22Z",
    "LastAvailableDateTime": "2019-08-24T14:15:22Z"
  }
}
```


### Response Headers

|Status|Header|Type|Format|Description|
|---|---|---|---|---|
|201|x-fapi-interaction-id|string||An RFC4122 UID used as a correlation id.|
|400|x-fapi-interaction-id|string||An RFC4122 UID used as a correlation id.|
|401|x-fapi-interaction-id|string||An RFC4122 UID used as a correlation id.|
|403|x-fapi-interaction-id|string||An RFC4122 UID used as a correlation id.|
|405|x-fapi-interaction-id|string||An RFC4122 UID used as a correlation id.|
|406|x-fapi-interaction-id|string||An RFC4122 UID used as a correlation id.|
|415|x-fapi-interaction-id|string||An RFC4122 UID used as a correlation id.|
|429|Retry-After|integer||Number in seconds to wait|
|429|x-fapi-interaction-id|string||An RFC4122 UID used as a correlation id.|
|500|x-fapi-interaction-id|string||An RFC4122 UID used as a correlation id.|

<aside class="warning">
To perform this operation, you must be authenticated by means of one of the following methods:
TPPOAuth2Security ( Scopes: accounts )
</aside>


## SDKs and Libraries
> Code samples
### Python

```python
import requests
headers = {
  'Content-Type': 'application/json; charset=utf-8',
  'Accept': 'application/json; charset=utf-8',
  'x-fapi-auth-date': 'string',
  'x-fapi-customer-ip-address': 'string',
  'x-fapi-interaction-id': 'string',
  'Authorization': 'string',
  'x-customer-user-agent': 'string'
}

r = requests.post('https://sandbox-mtls.ob.hsbc.co.uk/open-banking/v3.1/aisp/account-access-consents', headers = headers)

print(r.json())

```
### Ruby
```ruby
require 'rest-client'
require 'json'

headers = {
  'Content-Type' => 'application/json; charset=utf-8',
  'Accept' => 'application/json; charset=utf-8',
  'x-fapi-auth-date' => 'string',
  'x-fapi-customer-ip-address' => 'string',
  'x-fapi-interaction-id' => 'string',
  'Authorization' => 'string',
  'x-customer-user-agent' => 'string'
}

result = RestClient.post 'https://sandbox-mtls.ob.hsbc.co.uk/open-banking/v3.1/aisp/account-access-consents',
  params: {
  }, headers: headers

p JSON.parse(result)

```
## Error messages
   ### Error format
   API errors in two ways: standard HTTP response codes and human-readable messages in JSON format.
   
   ### Error – HTTP Response
   ```
   HTTP/1.1 405 Method Not Allowed
   Server: nginx
   Content-Type: application/problem+json; charset=utf-8
   Content-Length: 253
   X-Request-Id: a1efb240-f8d8-40fe-a680-c3a5619a42e9
   Link: <https://us2.api.mailchimp.com/schema/3.0/ProblemDetailDocument.json>; rel="describedBy"
   Date: Thu, 17 Sep 2015 19:02:28 GMT
   Connection: keep-alive
   Set-Cookie: _AVESTA_ENVIRONMENT=prod; path=/
   ```
   
   ### Error – JSON
   ```
   {
    "type": "https://mailchimp.com/developer/marketing/docs/errors/",
    "title": "Method Not Allowed",
    "status": 405,
    "detail": "The requested method and resource are not compatible. See the Allow header for this resource's available methods.",
    "instance": "3b4dcb40-0b6b-4820-bfaa-41267b3826ea"
    }
   ```
   ### Error Code Mappings
   |HTTP Status Code|Error Message|Error Scenario|Schema|
|---|---|---|---|
|400|[Bad Request](https://tools.ietf.org/html/rfc7231#section-6.5.1)|Bad request|[OBErrorResponse1](#schemaoberrorresponse1)|
|401|[Unauthorized](https://tools.ietf.org/html/rfc7235#section-3.1)|Unauthorized|None|
|403|[Forbidden](https://tools.ietf.org/html/rfc7231#section-6.5.3)|Forbidden|[OBErrorResponse1](#schemaoberrorresponse1)|
|405|[Method Not Allowed](https://tools.ietf.org/html/rfc7231#section-6.5.5)|Method Not Allowed|None|
|406|[Not Acceptable](https://tools.ietf.org/html/rfc7231#section-6.5.6)|Not Acceptable|None|
|429|[Too Many Requests](https://tools.ietf.org/html/rfc6585#section-4)|Too Many Requests|None|
|500|[Internal Server Error](https://tools.ietf.org/html/rfc7231#section-6.6.1)|Internal Server Error|[OBErrorResponse1](#schemaoberrorresponse1)|




## Change log
Change log and release history:

| Version | Release | Date  | Status | Description |
| ------- | --- | ---- |------------- | ----------- |
| V1 | October | 2018 |Deprecated | 	First Released version of HSS Custody API Overview & Technical Specification. |
| V2 | March | 2019 | Live | Released Trade status API to Hong Kong market |

## Document Version
| Version | Release | Date  | Author | Description |
| ------- | --- | ---- |------------- | ----------- |
|  |  | September 2019 |  | Added markets in scope for trade status including new markets released (Hong Kong, Australia, Japan Thailand, Philippines, South Korea) </br>Added new fields (limit, offset, group member ID, market reference, and security type) and enhanced field definitions </br>Added field input parameter definition|
 | | | December 2019| | Added new markets in scope (Singapore, New Zealand and UAE)|
 | | | April 2020 | | Updated to create technical specifications for Holdings API. New section added as summary of API information. |

