## Overview

The Trade Processing APIs are used to provide the account owner with information on their trade instructions within their accounts for a given date range or specific time during the day.

This document provides the guidelines required to enable organisations to implement the Settlement and Safekeeping API responses into their systems and processes. 

Trade Status API – allows clients to access trade related information and the latest status for all settled and pending trade instructions
This documentation is available for download using the following link: Custody Technical Specification -Trade Status V2.5 April 2021 API Portal


## Getting Started

### Terms and Condiditions

### Contact Detail


## Authentication
### API gateway

Clients should authenticate their API access by including their secret token in the API request. All API requests to the Securities Services API Gateway must be made over HTTPS.

The Securities Services API Gateway manages our client authentication and redirects the API request to the relevant domain platform. As all transmission will be over HTTPS (TLS 1.2 or above), and the web traffic will be encrypted from eavesdropping during transmission.

### Security token

Securities Services APIs uses security token for authentication and authorisation.

During the API Onboarding, we require the client to complete an API Profile Application Form. For each API Profile Application Form, we will generate one security token, i.e. one security token per API Profile Account. These security tokens are generated by the Securities Services Internal API Administrative Console, which is not accessible through the Internet.

Upon completion of the End to End API Testing and the terms and conditions being signed, the Securities Services API Onboarding team will send the token through secure email to client’s Token Delivery email address.


This security token is the Bearer token under the OAuth2.0 Authorisation Framework. It should be added to the client’s HTTP authorisation header in the request. This initial security token default expiry period is for one year. Close to the token expiry, subject to a token overlap period (default is 30 days and can be customised according to our client’s requirements), a secure email containing the new token will be sent to the Token Delivery Email address and specify the new token effective date and expiry date.

Securities Services will manage the security token (revoke/re-generate) on request.

### Additional security features

Securities Services API provides IP white-listing as an additional security measure. Client can specify the IP addresses they would like to access the Securities Services API with. IP addresses outside of the whitelist will not be able to access the API service.

Securities Services API also supports connection using leased line which provide a secured channel between the client network and HSBC network.

## Requests and Response

The Trade Status API allows clients to access their trade related information and the latest status for all settled and pending trade instructions. This includes the latest market and processing status available from Securities Services custody operating systems. This shall provide clients with the following benefits:

* Real-time access to trade status information
* Clients can obtain their trade information directly without having to rely on e-mail communications
* Clients can call the API to display the narrative describing the trade status and fail reasons
* Ability to determine the processing status of the trade, whether it is still being processed by the sub-custodian, released to the market, completed trade matching and exceptions, and finally if the trade has settled.
* Ability to extract historical trades that have previously been settled or cancelled in HSBC records.


<h3>Direct Custody - Trade Processing</h3>
 <a id=""></a>
`GET /v2/trades/`

Direct Custody - Trade Processing

> Body parameter

```json
{
   "tradeStatuses":"SETTLED",
   "hsbcTradeReferenceNumbers":"D-123456-00-0",
   "countryTerritoryLocationCodes":"HK"
}
```

<h3>Parameters</h3>

|Name|In|Type|Required|Description|
|---|---|---|---|---|
|limit|query|false|integer|Default value : 500|
|securitiesAccountNumbers|query|false|array(string)|nput by client, no more than 99 account numbers can be specified in one request.|
|transactionTypes|query|false|arary(string)|Input by client, a set of maximum 10 values can be entered with comma as separator.|
|hsbcTradeReferenceNumbers|query|false|array(string)|Input by client, no more than 99 HSBC Trade Reference Numbers can be specified.|
|clientReferences|query|false|array(string)|Input by client, no more than 99 client references can be specified.|
|tradeDatePeriodStart|query|false|string($date)|Input by client. If trade date period start is blank, extract up to oldest available trade date record in database.|
|instructionDatePeriodStart|query|false|string($date)|nput by client. If instruction date period end is blank, extract up to latest available instruction date record in database.|
|tradeStatuses|query|true|array[string]|Input by client, as mandatory. A set of maximum 10 values (UNMATCHED, MATCHED, FAILED, SETTLED, CANCELLED, ALL, PENDING, ALLEGED, PENDING_CANCELLATION, PENDING_AMENDMENT) can be entered with comma as separator. Refer to Appendix Trade API.|



#### Detailed descriptions

> Example responses

> 200 OK Response

```json
{
  "total": 500,
  "offset": 499,
  "count": 1,
  "data": [
    {
      "groupMemberId": "HSBC",
      "securitiesAccountNumber": "002-151074-421",
      "securitiesAccountName": "NBIT AWD MODEL OFFICE 3",
      "hsbcTradeReferenceNumber": "R-666666-22-1",
      "clientReference": "09291800003030C",
      "marketSpecificReference": "P12345678",
      "transactionType": "DVP",
      "tradeDate": "2018-04-12",
      "instructionDate": "2018-04-13",
      "contractualSettlementDate": "2018-04-14",
      "actualSettlementDate": "2018-04-15",
      "security": {
        "name": "CHINA SHANSHUI CEMENT GROUP LTD",
        "type": "CDEP",
        "isin": "AU3FN0001764",
        "sedol": "0263494",
        "cusip": "17275R102",
        "localSecurityCode": "string",
        "identifier": "G6469T1009BM"
      },
      "countryTerritoryLocationCode": "PL",
      "placeOfSettlementBic": "MGTCBEBEECL",
      "securityQuantity": "2609080",
      "dealPriceCurrency": "USD",
      "dealPrice": "123456.789",
      "settlementCurrency": "USD",
      "settlementAmount": "123456.789",
      "subCustodianName": "THE HONG KONG & SHANGHAI BANKING CORPORATION LIMIT",
      "associatedAccount": "91197",
      "associatedSubAccount": "91197",
      "valueDate": "2018-04-14",
      "counterparties": {
        "deliveringAgentReceivingAgent": {
          "name": "HSBC QATAR",
          "bic": "GKGTSGS1",
          "dataSourceSchemeType": "P",
          "dataSourceSchemeCode": "CCAS",
          "account": "567-891012-123"
        },
        "buyerSeller": {
          "name": "HSBC QATAR",
          "bic": "GKGTSGS1",
          "dataSourceSchemeType": "P",
          "dataSourceSchemeCode": "CCAS",
          "account": "567-891012-123"
        },
        "deliverersCustodianReceiversCustodian": {
          "name": "HSBC QATAR",
          "bic": "GKGTSGS1",
          "dataSourceSchemeType": "P",
          "dataSourceSchemeCode": "CCAS",
          "account": "567-891012-123"
        }
      },
      "tradeStatus": "string",
      "statusCode1SWIFT": "SETT//PEND",
      "status1ReasonCode1SWIFT": "IPRC//REPR",
      "status1ReasonCode2SWIFT": "IPRC//REPR",
      "statusCode2SWIFT": "SETT//PEND",
      "status2ReasonCode1SWIFT": "IPRC//REPR",
      "status2ReasonCode2SWIFT": "IPRC//REPR",
      "reasonNarrative": "Under processing by sub-custodian.",
      "lastUpdatedDateTime": {},
      "stpIndicator": "N"
    }
  ]
}


```
> 400 Bad Request

```json
{
  "title": "Bad Request",
  "status": 400,
  "detail": "",
  "invalidParams": [
    {
      "name": "tradeStatuses",
      "detail": "Parameter is required."
    }
  ],
  "requestId": "3247982",
  "supportTeam": "HSBC Securities Services",
  "supportContactEmail": "client.digital.experience.hssasp@hsbc.com.hk",
  "dateTime": "2018-08-13T12:48:20.278"
}

```
> 401 Authentication Error
```json
{
  "title": "Authentication failure",
  "status": 401,
  "detail": "",
  "requestId": "3247982",
  "supportTeam": "HSBC Securities Services",
  "supportContactEmail": "client.digital.experience.hssasp@hsbc.com.hk",
  "dateTime": "2018-08-13T12:48:20.278"
}
```
> 503 Server unavailable
```json
{
  "title": "Service Unavailable",
  "status": 503,
  "detail": "",
  "requestId": "3247982",
  "supportTeam": "HSBC Securities Services",
  "supportContactEmail": "client.digital.experience.hssasp@hsbc.com.hk",
  "dateTime": "2018-08-13T12:48:20.278"
}
```

### Response Headers


## SDKs and Libraries
> Code samples
### Python

```python
import http.client

conn = http.client.HTTPSConnection("api.securities-services.gbm.hsbc.com")

headers = { 'authorization': "Bearer REPLACE_BEARER_TOKEN" }

conn.request("GET", "/custody/v2/trades/?limit=SOME_INTEGER_VALUE&offset=SOME_INTEGER_VALUE&securitiesAccountNumbers=SOME_ARRAY_VALUE&transactionTypes=SOME_ARRAY_VALUE&hsbcTradeReferenceNumbers=SOME_ARRAY_VALUE&clientReferences=SOME_ARRAY_VALUE&tradeDatePeriodStart=SOME_STRING_VALUE&tradeDatePeriodEnd=SOME_STRING_VALUE&instructionDatePeriodStart=SOME_STRING_VALUE&instructionDatePeriodEnd=SOME_STRING_VALUE&contractualSettlementDatePeriodStart=SOME_STRING_VALUE&contractualSettlementDatePeriodEnd=SOME_STRING_VALUE&actualSettlementDatePeriodStart=SOME_STRING_VALUE&actualSettlementDatePeriodEnd=SOME_STRING_VALUE&lastUpdatedDateTimePeriodStart=SOME_STRING_VALUE&lastUpdatedDateTimePeriodEnd=SOME_STRING_VALUE&countryTerritoryLocationCodes=SOME_ARRAY_VALUE&placeOfSettlementBics=SOME_ARRAY_VALUE&tradeStatuses=SOME_ARRAY_VALUE&reasonCodesSWIFT=SOME_ARRAY_VALUE", headers=headers)

res = conn.getresponse()
data = res.read()

print(data.decode("utf-8"))

```
### Java
```java
OkHttpClient client = new OkHttpClient();

Request request = new Request.Builder()
  .url("https://api.securities-services.gbm.hsbc.com/custody/v2/trades/?limit=SOME_INTEGER_VALUE&offset=SOME_INTEGER_VALUE&securitiesAccountNumbers=SOME_ARRAY_VALUE&transactionTypes=SOME_ARRAY_VALUE&hsbcTradeReferenceNumbers=SOME_ARRAY_VALUE&clientReferences=SOME_ARRAY_VALUE&tradeDatePeriodStart=SOME_STRING_VALUE&tradeDatePeriodEnd=SOME_STRING_VALUE&instructionDatePeriodStart=SOME_STRING_VALUE&instructionDatePeriodEnd=SOME_STRING_VALUE&contractualSettlementDatePeriodStart=SOME_STRING_VALUE&contractualSettlementDatePeriodEnd=SOME_STRING_VALUE&actualSettlementDatePeriodStart=SOME_STRING_VALUE&actualSettlementDatePeriodEnd=SOME_STRING_VALUE&lastUpdatedDateTimePeriodStart=SOME_STRING_VALUE&lastUpdatedDateTimePeriodEnd=SOME_STRING_VALUE&countryTerritoryLocationCodes=SOME_ARRAY_VALUE&placeOfSettlementBics=SOME_ARRAY_VALUE&tradeStatuses=SOME_ARRAY_VALUE&reasonCodesSWIFT=SOME_ARRAY_VALUE")
  .get()
  .addHeader("authorization", "Bearer REPLACE_BEARER_TOKEN")
  .build();

Response response = client.newCall(request).execute();
```

### Javascript
```javascript
var data = null;

var xhr = new XMLHttpRequest();
xhr.withCredentials = true;

xhr.addEventListener("readystatechange", function () {
  if (this.readyState === this.DONE) {
    console.log(this.responseText);
  }
});

xhr.open("GET", "https://api.securities-services.gbm.hsbc.com/custody/v2/trades/?limit=SOME_INTEGER_VALUE&offset=SOME_INTEGER_VALUE&securitiesAccountNumbers=SOME_ARRAY_VALUE&transactionTypes=SOME_ARRAY_VALUE&hsbcTradeReferenceNumbers=SOME_ARRAY_VALUE&clientReferences=SOME_ARRAY_VALUE&tradeDatePeriodStart=SOME_STRING_VALUE&tradeDatePeriodEnd=SOME_STRING_VALUE&instructionDatePeriodStart=SOME_STRING_VALUE&instructionDatePeriodEnd=SOME_STRING_VALUE&contractualSettlementDatePeriodStart=SOME_STRING_VALUE&contractualSettlementDatePeriodEnd=SOME_STRING_VALUE&actualSettlementDatePeriodStart=SOME_STRING_VALUE&actualSettlementDatePeriodEnd=SOME_STRING_VALUE&lastUpdatedDateTimePeriodStart=SOME_STRING_VALUE&lastUpdatedDateTimePeriodEnd=SOME_STRING_VALUE&countryTerritoryLocationCodes=SOME_ARRAY_VALUE&placeOfSettlementBics=SOME_ARRAY_VALUE&tradeStatuses=SOME_ARRAY_VALUE&reasonCodesSWIFT=SOME_ARRAY_VALUE");
xhr.setRequestHeader("authorization", "Bearer REPLACE_BEARER_TOKEN");

xhr.send(data);

```

## Error messages
   ### Error format
   API errors in two ways: standard HTTP response codes and human-readable messages in JSON format.
   
   ### Error – HTTP Response
   ```
   ```
   
   ### Error – JSON
   ```
{
  "title": "Service Unavailable",
  "status": 503,
  "detail": "",
  "requestId": "3247982",
  "supportTeam": "HSBC Securities Services",
  "supportContactEmail": "client.digital.experience.hssasp@hsbc.com.hk",
  "dateTime": "2018-08-13T12:48:20.278"
}
   ```
   ### Error Code Mappings
   |HTTP Status Code|Error Message|Error Scenario|Possible Root Cause|Suggested Action|
|---|---|---|---|---|
|200|OK|Standard response for successful HTTP requests|- Legitimate request is processed without errors|- No action is required|
|400|Bad Request|The server cannot or will not process the request due to an apparent client error (e.g., malformed request syntax, size too large, invalid parameters)|- Input parameter(s) is supplied in invalid format. For the details of validation, please refer to the following section on the Validation Framework</br>- No token is supplied in the request header|- Review the validation errors in conjunction with the Validation Framework and/or review the API Specification|
|401|Unauthorized|Similar to 403 Forbidden, but specifically for use when authentication is required and has failed or has not yet been provided|- Invalid token or expired token is supplied in the request header</br>- Valid token is supplied however the API Profile Account has not been fully set-up|- Confirm a valid token has been supplied</br>- Confirm the supplied token has been registered with a valid and non-elapsed profile</br>- Confirm the API Profile Account has been fully set-up|
|403|Forbidden|The request was valid, but the server is refusing action. The user might not have the necessary permissions for a resource|- Valid token has been supplied and the profile is validated; however the profile does not have the permissions to access the specified API</br>- Valid token has been supplied and the profile is validated; however the profile does not have the permissions to access the specified accounts|- Confirm a valid token has been supplied</br>- Confirm the profile has access to the specified API’s and/or accounts|
|404|	Not Found|The requested resource could not be found but may be available in the future. Subsequent requests by the client are permissible|- An incorrect URI is used in the request, which points to no resource or service|- Confirm if the request is submitted to the correct URI|
|405|Method Not Allowed|A request method is not supported for the requested resource. For example, a GET request on a form that requires data to be presented via POST, or a PUT request on a read-only resource|- An incorrect method is used in the request which the service does not support|- Confirm if the request is submitted with the correct method. Allowed methods for the API can be viewed in the API Specification|
|429|Too Many Requests|The user has sent too many requests in a given amount of time|- The client has reached its maximum allowed rate limit for the time current period|- Wait and resubmit request later|
|500|Internal Server Error|A generic error message, given when an unexpected condition was encountered and no more specific message is suitable|- Unexpected processing error has been encountered|- Contact HSS API Support team to investigate the error. Provide the error with the request Id from the error|
|502|Bad Gateway|The server was acting as a gateway or proxy and received an invalid response from the upstream server|- API Gateway is unable to response to the request|- Confirm the request is within the hours of operation. There may be down-time associated with maintenance</br>- Contact HSS API Support team to investigate the error. Provide the error with the request Id from the error|
|503|Service Unavailable|The server is currently unavailable|- Servers are unavailable at this time|- Confirm the request is within the hours of operation. There may be down-time associated with maintenance</br>-Contact HSS API Support team to investigate the error. Provide the error with the request Id from the error|




## Change log
Change log and release history:

| Version | Release | Date  | Status | Description |
| ------- | --- | ---- |------------- | ----------- |
| V1 | October | 2018 |Deprecated | 	First Released version of HSS Custody API Overview & Technical Specification. |
| V2 | March | 2019 | Live | Released Trade status API to Hong Kong market |

## Document Version
| Version | Release | Date  | Author | Description |
| ------- | --- | ---- |------------- | ----------- |
|  |  | September 2019 |  | Added markets in scope for trade status including new markets released (Hong Kong, Australia, Japan Thailand, Philippines, South Korea) </br>Added new fields (limit, offset, group member ID, market reference, and security type) and enhanced field definitions </br>Added field input parameter definition|
 | | | December 2019| | Added new markets in scope (Singapore, New Zealand and UAE)|
 | | | April 2020 | | Updated to create technical specifications for Holdings API. New section added as summary of API information. |

